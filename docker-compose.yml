services:
  nginx:
    image: nginx:alpine
    container_name: testops-forge-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - testops_reports:/usr/share/nginx/html/static/reports
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    networks:
      - forge-network

  docker:
    image: docker:24-dind
    container_name: testops-forge-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    volumes:
      - testops_dind_data:/var/lib/docker
      - testops_temp:/app/temp_execution
    healthcheck:
      test: ["CMD", "docker", "ps"]
      interval: 5s
      timeout: 10s
      retries: 5
    networks:
      - forge-network

  runner-builder:
    image: docker:latest
    container_name: testops-forge-runner-builder
    command: >
      sh -c "docker --host tcp://docker:2375 build -t testops-runner:latest -f /app/backend/Dockerfile.runner /app/backend"
    volumes:
      - ./backend:/app/backend
    depends_on:
      docker:
        condition: service_healthy
    networks:
      - forge-network

  redis:
    image: redis:7-alpine
    container_name: testops-forge-redis
    networks:
      - forge-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: testops-forge-backend
    env_file:
      - ./backend/.env
    environment:
      - DOCKER_HOST=tcp://docker:2375
      - DATABASE_URL=postgresql+asyncpg://testops:testops@db:5432/testops
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - PLAYWRIGHT_REMOTE_ENABLED=${PLAYWRIGHT_REMOTE_ENABLED:-0}
      - PLAYWRIGHT_BROWSER=${PLAYWRIGHT_BROWSER:-chromium}
    volumes:
      - testops_storage:/app/storage
      - testops_temp:/app/temp_execution
      - testops_reports:/app/static/reports
      - chroma_model_cache:/root/.cache/chroma
    depends_on:
      db:
        condition: service_healthy
      chromadb:
        condition: service_started
      docker:
        condition: service_healthy
      redis:
        condition: service_healthy
      runner-builder:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8000/api/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 30s
    networks:
      - forge-network

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: testops-forge-worker
    command: celery -A src.app.core.celery_app worker -l INFO
    env_file:
      - ./backend/.env
    environment:
      - DOCKER_HOST=tcp://docker:2375
      - DATABASE_URL=postgresql+asyncpg://testops:testops@db:5432/testops
      - CHROMA_HOST=chromadb
      - CHROMA_PORT=8000
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - PLAYWRIGHT_REMOTE_ENABLED=${PLAYWRIGHT_REMOTE_ENABLED:-0}
      - PLAYWRIGHT_BROWSER=${PLAYWRIGHT_BROWSER:-chromium}
    volumes:
      - testops_storage:/app/storage
      - testops_temp:/app/temp_execution
      - testops_reports:/app/static/reports
      - chroma_model_cache:/root/.cache/chroma
    depends_on:
      db:
        condition: service_healthy
      docker:
        condition: service_healthy
      redis:
        condition: service_healthy
      runner-builder:
        condition: service_completed_successfully
    networks:
      - forge-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: testops-forge-frontend
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost/"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - forge-network

  db:
    image: postgres:15-alpine
    container_name: testops-forge-db
    environment:
      - POSTGRES_USER=testops
      - POSTGRES_PASSWORD=testops
      - POSTGRES_DB=testops
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testops"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - forge-network

  chromadb:
    image: chromadb/chroma:latest
    container_name: testops-forge-chroma
    volumes:
      - chroma_data:/chroma/chroma
    networks:
      - forge-network

networks:
  forge-network:
    driver: bridge

volumes:
  postgres_data:
  chroma_data:
  testops_storage:
  testops_temp:
  testops_reports:
  testops_dind_data:
  chroma_model_cache:
